analysisfolder = '/Users/dlevenstein/Project Repos/ACh-and-CorticalState/AnalysisScripts/AnalysisFigs/LFPSlopeAndPupilAnalysis';
PSSandPupilAll = GetMatResults(analysisfolder,'LFPSlopeAndPupilAnalysis');
%genotype = {PupilWhiskAll.genotype};
%[genotypes,~,genotypeidx] = unique(genotype);
%%
PSSandPupil = bz_CollapseStruct(PSSandPupilAll);

%%
animalname = extractBefore(PSSandPupil.name, '_');
genotype = extractBetween(PSSandPupil.name,'_','_');
genotype = genotype(:,:,1);
[genotypes,~,genotypeidx] = unique(genotype);
%genotypes = char(genotypes);
%%
slopepupilcorr.ALL = bz_CollapseStruct(PSSandPupil.slopepupilcorr,1,'justcat',1);
slopepupilcorr.chans = 1:length(slopepupilcorr.ALL.dpdt);

pupcyclePSS.ALL = bz_CollapseStruct(PSSandPupil.pupcyclePSS,3);
pupcyclePSS.bins = PSSandPupil.pupcyclePSS.bincenters;

PSShist.ALL =  bz_CollapseStruct(PSSandPupil.PSShist,1);
PSShist.bins = PSSandPupil.PSShist.bins;

for gg = 1:length(genotypes)
    slopepupilcorr.dpdt.(genotypes{gg}) = mean(slopepupilcorr.ALL.dpdt(genotypeidx==gg,:),1);
    slopepupilcorr.pup.(genotypes{gg}) = mean(slopepupilcorr.ALL.pup(genotypeidx==gg,:),1);
    
    pupcyclePSS.meanPSS.(genotypes{gg}) = nanmean(pupcyclePSS.ALL.meanPSS(:,:,genotypeidx==gg),3);
    
    PSShist.(genotypes{gg}) = mean(PSShist.ALL.hist(genotypeidx==gg,:),1);
    
end

%%
figure
subplot(3,2,1)
    plot(slopepupilcorr.chans,slopepupilcorr.pup.WT,'k','linewidth',2)
    hold on
    plot(slopepupilcorr.chans,slopepupilcorr.dpdt.WT,'k--','linewidth',1)
    plot(slopepupilcorr.chans,slopepupilcorr.pup.EMX,'r','linewidth',2)
    plot(slopepupilcorr.chans,slopepupilcorr.dpdt.EMX,'r--','linewidth',1)

    xlim(slopepupilcorr.chans([1 end]));ylim([0 0.5])
    box off
    ylabel('Pup-PSS Corr');xlabel('Channel (Sup<---->Deep)')

  for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(6,3,rr+(gg)*6)
        plot(slopepupilcorr.chans,slopepupilcorr.ALL.pup(recs(rr),:),'k','linewidth',2)
        hold on
        plot(slopepupilcorr.chans,slopepupilcorr.ALL.dpdt(recs(rr),:),'k','linewidth',0.5)
        plot(slopepupilcorr.chans([1 end]),[0 0],'k--')
        xlim(slopepupilcorr.chans([1 end]));ylim([-0.3 0.7])
        title(animalname{recs(rr)})
    end
  end
 NiceSave('PSSpupCorr',analysisfolder,'_')
 
 
 %% FIgure: PSS and pup cycle
 figure
for gg = 1:length(genotypes)
    subplot(2,2,gg)
        h = imagesc(pupcyclePSS.bins,pupcyclePSS.bins,pupcyclePSS.meanPSS.(genotypes{gg})');
        set(h,'AlphaData',~isnan(pupcyclePSS.meanPSS.(genotypes{gg})'))
        colorbar
        hold on
        plot(pupcyclePSS.bins([1 end]),[0 0],'k--')
        axis xy
        caxis([-1.2 -0.5])
        title(['PSS: ',genotypes{gg}])
        %xlim([-0.6 0.5])
        LogScale('x',10)
        xlabel('Pupil Area');ylabel('dp/dt')
        
end
    
%%
figure
for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(4,3,rr+(gg-1)*6)
            h = imagesc(pupcyclePSS.bins,pupcyclePSS.bins,pupcyclePSS.ALL.meanPSS(:,:,recs(rr))');
            set(h,'AlphaData',~isnan(pupcyclePSS.ALL.meanPSS(:,:,recs(rr))'))
            colorbar
            hold on
            plot(pupcyclePSS.bins([1 end]),[0 0],'k--')
            axis xy
            caxis([-1.2 -0.5])
            title(['DPSS: ',animalname{recs(rr)}])
            %xlim([-0.6 0.5])
            LogScale('x',10)
            xlabel('Pupil Area');ylabel('dp/dt')
    end
end
%%
pupcycleUPDOWN.ALL = bz_CollapseStruct(PSSandPupil.pupcycleUPDOWN,3);
pupcycleUPDOWN.bins = PSSandPupil.pupcycleUPDOWN.bincenters;

pupphaseUD.ALL = bz_CollapseStruct(PSSandPupil.pupphaseUD,1,'justcat',true);
pupphaseUD.freqs = PSSandPupil.pupphaseUD.freqs;

islowhist.ALL = bz_CollapseStruct(PSSandPupil.islowhist,3);
islowhist.phasebins = PSSandPupil.islowhist.phasebins;
islowhist.ampbins = PSSandPupil.islowhist.ampbins;

pupbyislow.ALL = bz_CollapseStruct(PSSandPupil.pupbyislow,3);
pupbyislow.phasebins = PSSandPupil.pupbyislow.phasebins;
pupbyislow.ampbins = PSSandPupil.pupbyislow.ampbins;

%%
for gg = 1:length(genotypes)
    pupcycleUPDOWN.pDOWN.(genotypes{gg}) = nanmean(pupcycleUPDOWN.ALL.pDOWN(:,:,genotypeidx==gg),3);
    pupcycleUPDOWN.logUPdur.(genotypes{gg}) = nanmean(pupcycleUPDOWN.ALL.logUPdur(:,:,genotypeidx==gg),3);
    
    pupphaseUD.phaseDN.(genotypes{gg}) = nanmean(pupphaseUD.ALL.phaseDN.mag(genotypeidx==gg,:),1);
    pupphaseUD.phaseUPdur.(genotypes{gg}) = nanmean(pupphaseUD.ALL.phaseUPdur.corr(genotypeidx==gg,:),1);
    
    islowhist.pDOWNPUP.(genotypes{gg}) = nanmean(islowhist.ALL.pDOWNPUP(:,:,genotypeidx==gg),3);
    islowhist.pDOWNPUP_marg.(genotypes{gg}) = nanmean(islowhist.ALL.pDOWNPUP_marg(:,:,genotypeidx==gg),3);
    
    pupbyislow.meanpupbyphase.(genotypes{gg}) = nanmean(pupbyislow.ALL.meanpupbyphase(:,:,genotypeidx==gg),3);
end

%% All Recordings: UP/DOWN and dpdt
figure
for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(4,3,rr+(gg-1)*6)
            h = imagesc(pupcycleUPDOWN.bins,pupcycleUPDOWN.bins,pupcycleUPDOWN.ALL.pDOWN(:,:,recs(rr))');
            set(h,'AlphaData',~isnan(pupcycleUPDOWN.ALL.pDOWN(:,:,recs(rr))'))
            colorbar
            hold on
            plot(pupcycleUPDOWN.bins([1 end]),[0 0],'k--')
            axis xy
            caxis([0 3])
            title(['DN rate: ',animalname{recs(rr)}])
            %xlim([-0.6 0.5])
            LogScale('x',10)
            xlabel('Pupil Area');ylabel('dp/dt')
    end
end
NiceSave('PupandDOWN_all',analysisfolder,'_')

figure
for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(4,3,rr+(gg-1)*6)
            h = imagesc(pupcycleUPDOWN.bins,pupcycleUPDOWN.bins,pupcycleUPDOWN.ALL.logUPdur(:,:,recs(rr))');
            set(h,'AlphaData',~isnan(pupcycleUPDOWN.ALL.logUPdur(:,:,recs(rr))'))
            colorbar
            hold on
            plot(pupcycleUPDOWN.bins([1 end]),[0 0],'k--')
            axis xy
            title(['UP dur: ',animalname{recs(rr)}])
            LogScale('x',10)
            caxis([-1 1])
            LogScale('c',10)
            LogScale('x',10)
            xlabel('Pupil Area');ylabel('dp/dt')
    end
end

NiceSave('PupandUP_all',analysisfolder,'_')


%% UP/DOWN and dpdt
figure
for gg = 1:length(genotypes)
    subplot(2,2,gg)
        h = imagesc(pupcycleUPDOWN.bins,pupcycleUPDOWN.bins,pupcycleUPDOWN.pDOWN.(genotypes{gg})');
        set(h,'AlphaData',~isnan(pupcycleUPDOWN.pDOWN.(genotypes{gg})'))
        colorbar
        hold on
        plot(pupcycleUPDOWN.bins([1 end]),[0 0],'k--')
        axis xy
        caxis([0 3])
        title(['DOWN rate: ',genotypes{gg}])
        %xlim([-0.6 0.5])
        LogScale('x',10)
        xlabel('Pupil Area');ylabel('dp/dt')
        
        
    subplot(2,2,gg+2)
        h = imagesc(pupcycleUPDOWN.bins,pupcycleUPDOWN.bins,pupcycleUPDOWN.logUPdur.(genotypes{gg})');
        set(h,'AlphaData',~isnan(pupcycleUPDOWN.logUPdur.(genotypes{gg})'))
        colorbar
        hold on
        plot(pupcycleUPDOWN.bins([1 end]),[0 0],'k--')
        axis xy
        %caxis([0 3])
        title(['mean UP duration: ',genotypes{gg}])
        LogScale('x',10)
        caxis([-1 1])
        LogScale('c',10)
        xlabel('Pupil Area');ylabel('dp/dt')
end


NiceSave('PupandUPDOWN_mean',analysisfolder,'_')

%% Phase Coupling: DOWN incidence

figure
    subplot(2,2,1)
        plot(log10(pupphaseUD.freqs),pupphaseUD.phaseDN.WT,'k','linewidth',2)
        hold on
        plot(log10(pupphaseUD.freqs),pupphaseUD.phaseDN.EMX,'r','linewidth',2)
        LogScale('x',10)
        xlabel('Pupil Freq (Hz)');ylabel('DOWN-Pupil Coupling')
    

        
    for gg = 1:length(genotypes)
        subplot(4,2,2.*gg)

        imagesc(islowhist.phasebins,islowhist.ampbins,islowhist.pDOWNPUP.(genotypes{gg})')
        hold on
        imagesc(islowhist.phasebins+2*pi,islowhist.ampbins,islowhist.pDOWNPUP.(genotypes{gg})')
        axis xy
        xlim(pi.*[-1 3])
        clim([0 2.5])
        colorbar('location','east')
        ylabel('iSlow Amp')
        title([genotypes{gg},': DN rate'])
    end
    
        subplot(4,2,6)
            bar(islowhist.phasebins,islowhist.pDOWNPUP_marg.EMX,'r')
            hold on
            bar(islowhist.phasebins+2*pi,islowhist.pDOWNPUP_marg.EMX,'r')
            bar(islowhist.phasebins,islowhist.pDOWNPUP_marg.WT,'k')
            bar(islowhist.phasebins+2*pi,islowhist.pDOWNPUP_marg.WT,'k')
            box off
            axis tight
            %colorbar
            ylabel('Mean DOWN rate')
            
        subplot(4,2,8)
            plot(pupbyislow.phasebins,pupbyislow.meanpupbyphase.WT,'k')
            hold on
            plot(pupbyislow.phasebins+2*pi,pupbyislow.meanpupbyphase.WT,'k')
            plot(pupbyislow.phasebins,pupbyislow.meanpupbyphase.EMX,'r')
            plot(pupbyislow.phasebins+2*pi,pupbyislow.meanpupbyphase.EMX,'r')
            axis tight
            xlabel('Pupil: iSlow Phase (0.005-0.05Hz)')
            ylabel('Mean Pupil Area')

NiceSave('PupPhaseandDOWN_mean',analysisfolder,'_')
 %% all recordings...
 
 figure
 for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(4,3,rr+(gg-1)*6)
            imagesc(islowhist.phasebins,islowhist.ampbins,islowhist.ALL.pDOWNPUP(:,:,recs(rr))')
            hold on
            imagesc(islowhist.phasebins+2*pi,islowhist.ampbins,islowhist.ALL.pDOWNPUP(:,:,recs(rr))')
            axis xy
            xlim(pi.*[-1 3])
            clim([0 2.5])
            colorbar('location','east')
            ylabel('iSlow Amp')
            title(['DN rate: ',animalname{recs(rr)}])
    end
 end
 NiceSave('DNbypupislow_all',analysisfolder,'_')
 
 figure
  for gg = 1:length(genotypes)
    recs = find(genotypeidx==gg);
    for rr = 1:length(recs)
        subplot(4,3,rr+(gg-1)*6)
            plot(log10(pupphaseUD.freqs),pupphaseUD.ALL.phaseDN.mag(recs(rr),:),'k','linewidth',1)
            hold on
            plot(log10(pupphaseUD.freqs(pupphaseUD.ALL.phaseDN.sig(recs(rr),:)>3)),...
                pupphaseUD.ALL.phaseDN.mag(recs(rr),(pupphaseUD.ALL.phaseDN.sig(recs(rr),:)>3)),'k.','markersize',10)
            LogScale('x',10)
            xlabel('Pupil Freq (Hz)');ylabel('DOWN-Pupil Coupling')
            ylim([0 0.25])
            title(['Pup-DN coupling: ',animalname{recs(rr)}])
    end
  end
  NiceSave('DNbypupphase_all',analysisfolder,'_')
%% Phase Coupling: UP duration
figure
    subplot(2,2,2)
        plot(log10(pupphaseUD.freqs),pupphaseUD.phaseUPdur.WT,'k','linewidth',2)
        hold on
        plot(log10(pupphaseUD.freqs),pupphaseUD.phaseUPdur.EMX,'r','linewidth',2)
        LogScale('x',10)
        xlabel('Pupil Freq (Hz)');ylabel('UPdur-Pupil Corr')
        
NiceSave('PupPhaseandUP_mean',analysisfolder,'_')